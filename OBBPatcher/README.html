<html>
<head>
	<title>1Zulu's OBB Patcher</title>
	<style>
	body {width: 1024px; text-align: left}
	center {text-align: center;}
	* {font-family: Helvetica, Arial, sans-serif; font-size: 14px;}
	.code {font-family: Courier New;}
	.important {color:red; font-weight:bold}
	.note {
			font-size: 12px; 
			font-style: italic;
			margin: 12px 24px 0px 32px;	
	}
			
	.smaller {display: block; font-size: 24px; padding-top: 4px }
	.clear { clear: both; }
	
	h1 {
	  font-weight: normal;
	  font-size: 28px;
	  font-weight: normal;
	  text-transform: uppercase;
	  /*float: left;*/
	  margin: 24px 32px 0px ;
	}
	
	h1 span {
		text-transform: none;
		font-size: 28px;
	}

	img { margin: 16px 0px}
	.pad { margin: 12px}
	
	.tabs input[type=radio] {
		display : none;
	}
	
	.alist {
		list-style: disc outside;
	}
 
	.tabs {
		width: 1000px;
		float: none;
		list-style: none;
		position: absolute;
		padding: 0;
		margin: 16px 32px;
	}
	 
	.tabs li{
		float: left;
	}
	 
	.tabs label {
		display: block;
		padding: 10px 20px;
		color: #FFFFFF;
		font-size: 22px;
		font-weight: normal;
		background: #2c3e50;
		cursor: pointer;
		position: relative;
	}
	 
	.tabs label:hover {
		background: #3498db;
	}
	 
	.tab-content {
		z-index: 2;
		display: none;
		left: 0;
		width: 100%;
		font-size: 18px;
		line-height: 140%;
		padding: 15px;
		position: absolute;
		box-sizing: border-box;
		border:1px solid #ccc;
		border-top: 10px solid #08C;
		background-color:#ffffff;
	}
	
	[id^=tab]:checked + label {
		background: #08C;
		color: white;
		top: 0;
	}
	 
	[id^=tab]:checked ~ [id^=tab-content] {
		display: block;
	}

	</style>
</head>
<div>
<h1>OBB Patcher (<span>v</span>0.05<span>b</span>)<span class="smaller">by 1Zulu</span></h1>
<br style="clear: both;" />
</div>
<div class="note">
<p>If this doesn't display properly, try using a different browser (Chrome/Firefox recommended)</p>
</div>

<div>
<ul class="tabs">

    <li>
        <input type="radio" name="tabs" id="tab1" checked>
        <label for="tab1">Instructions</label>
        <div id="tab-content1" class="tab-content">
            <h3>Step-by-step Instructions</h3>
			<div class="pad">
			<p>1. Copy the obb or rsb file (eg: <span class="code">main.91.com.ea.game.pvz2_na.obb</span>) to the same folder where you extracted this. You should end up with a directory that looks like this:<br /> 
			<img src=".\images\mod1.png" /></p>
			<p>2. Select the OBB file and click "Extract." Make sure this is the <b>original</b>, unmodified OBB!
			<br />
			Autodetecting the version should work fine, but you can override it if you wish.<br />
			<img src=".\images\mod2.png" /><br />
			This decompresses the compressed section into a file named <span class="code">&lt;version&gt;.section</span>, for example, <span class="code">91_3.6.1_obb_mod.section</span>
			<p>3. Make a copy of the section file you just extracted, and name it something else, like <span class="code">mod.91.section</span>.</p>
			<p>4. Use your favorite hex editor to edit <span class="code">mod.91.section</span>. 
			</p>
			<p>5. Once you are done with your edits, double click on OBBPatcher.jar to launch it. It may take a while to load Java. If you don't have Java installed, you'll need to install Java. You may also need to upgrade to Java 7 if you have an older version installed.</p>
			<p>6. Select the OBB file, and the modified section file (eg: <span class="code">mod.91.section</span>) and click "Patch."
			<br />
			Autodetecting the version should work fine, but you can override it if you wish.
			<br />
			<img src=".\images\mod3.png" /><br />
			Congratulations! The obb file has been modified.
			</p>
			<p>8. You can continue to modify the section file and re-run "Patch" if you keep the window open.</p>
			</div>
			<p>
			<hr />
			<center>
			<span class="important">IMPORTANT:</span> This modifies the obb file given as input! 
			<br />Keep a <b>backup</b> of your OBB.
			</center>
			</p>
			
        </div>
    </li>
    <li>
        <input type="radio" name="tabs" id="tab2">
        <label for="tab2">FAQ</label>
        <div id="tab-content2" class="tab-content">
            <h3>FAQ</h3>
            <p>
			Q: I can't open the program<br />
			A: Make sure you have Java installed. I recommend upgrading to Java 7 if you have an older version. Also give it a minute because it may take a little while to start.
			<p>
			Q: The program closes itself with an error message<br />
			A: Read the error message. Either you are missing the versions.cfg file (which should be in the same folder as the JAR), or you have no usable definitions in the versions.cfg. See the "Configuration" section for more information.
			</p>
			<p>
			Q: How do I modify the game so it does ______?<br />
			A: I don't know; don't ask me.
			</p>
			<p>
			Q: The game crashes after I changed ______. How do I fix it?<br />
			A: I don't know; don't ask me.
			</p>
			<p>
			Q: What does it mean when it says <span class="code">"resulting block was X byte(s) bigger than original"</span>?<br />
			A: It means the recompressed block ended up being bigger than the original compressed section. As the difference increases, so does the chance of the game crashing. This is especially true in the iOS version where you don't have a lot of room. This may or may not be fixable going forward.<br />
			</p>
			<p>
			Q: Does this work on Mac OS X or Linux?<br />
			A: I haven't tested it on either platform, but it should. If you can't launch it by double clicking the JAR file, you can open a Terminal window, <span class="code">cd</span> into the folder where you extracted it, and launch it by entering <span class="code">java -jar OBBPatcher.jar</span><br />
			</p>
			<p>
			Q: What versions are supported?<br />
			A: OBBs: 3.4.4 (82), 3.5.1 (85), 3.6.1 (91), 3.7.1 (96); RSBs: 3.6.2<br />
			<p>
			Q: How do I extract textures?<br />
			A: Right now this process is a little complicated and requires a lot of manual steps. I plan to automate this in a future release. If you still want to try, follow these steps:<br />

			<div class="pad">
			<p>1. Add one of these lines to the top of versions.cfg (select the version you have):

			<p class="pad code">
			96_obb_seedpackets: 507596800, 256946176, -259753450<br />
			91_obb_seedpackets: 502419456, 259354624, -261914623
			</p>
			</p>

			<p>2. Restart OBBPatcher</p>
			<p>3. Select the OBB file</p>
			<p>4. Select "<span class="code">9x_obb_seedpackets</span>" from the version dropdown.</p>
			<p>5. Click on "Extract." This will generate a file "<span class="code">9x_obb_seedpackets.section</span>." This is the texture file.</p>
			<p>6. To load and convert the texture to a usable image, you'll need to download and install PVRTextTool, which is part of PowerVR Tools.<br /> 
			You can find it on the <a href="http://www.imgtec.com/tools/powervr-tools/index.asp">Imagination Technologies</a> website.</p>
			<p>7. Launch PVRTextTool</p>
			<p>8. Select "File," and "Wrap Raw Data"</p>
			<p>9. Select the texture file (eg: "<span class="code">9x_obb_seedpackets.section</span>") and enter these exact options and open:<br />
			<img src=".\images\texture_unpack.png" /><br />
			If the the texture doesn't look right, check that you selected <b>EXACTLY</b> the same options as the picture above.
			</p>
			<p>10. Select "File" and then "Save Image." This will allow you to save to a PNG</p>
			</div>
			<p>
			And there you have it! You have extracted a texture from the game! Note that this is the <i>easiest</i> texture to extract.<br />
			Compressed textures are a much bigger problem. This is why you should wait for the next release, where all or most of this will be done automatically.
			</p>

			<p>
			Q: I have a question <b>that's not answered here</b> / bug report / feature request<br />
			A: Go to the OBBPatcher page on the PvZ wikia <a href="http://plantsvszombies.wikia.com/wiki/User:1Zulu/OBBPatcher">here</a>, find the current discussion thread, and contact me there. You'll need a wikia account. <br />
			</p>
        </div>
    </li>
    <li>
        <input type="radio" name="tabs" id="tab3">
        <label for="tab3">Configuration</label>
        <div id="tab-content3" class="tab-content">
            <h3>Configuration</h3>	
			<b>versions.cfg explained</b>
			<p>
			Starting with version 0.05, OBBPatcher will load version definitions from a file, <span class="code">versions.cfg</span>.<br /> This is a text file that can be edited by any text editor (like Notepad or Notepad++)
			</p>
			<p>
			This allows you to add your own definitions, which means you can extract any arbitrary section of the file (including textures, sound assets, etc.)<br />
			It will also save me time with the countless RSB versions. From now on I'll only add OBB definitions. You'll have to add RSB definitions yourself. <br />
			</p>
			<p>
			The format is very simple. Each line contains one version definition with the following format:
			</p>
			<pre class="pad code">
         name: file_size, offset, packed_size

         name = can be any alphanumeric character plus underscore "_" and dot "."
    file_size = size of the entire OBB file in bytes
       offset = offset where the compressed data starts
  packed_size = size of the compressed block in bytes; 
if this number is negative then it treats it as the end offset </pre>
			<p>
			All the numbers are in decimal (<b>not</b> hex!). For example:
			</p>
			<pre class="pad code">
    96_3.7.1_obb: 507596800, 56254464, 383421
			</pre>
			<p>
			You can use ";" or "#" to comment, eg:
			</p>
			<pre class="pad code">
    ; temporarily commenting out version below
    ;96_3.7.1_obb: 507596800, 56254464, 383421
			</pre>
			<p>
			The versions are loaded when OBBPatcher is launched, which means you have to restart the application if you make any changes to the file.
			<p>
			<b>Finding Compressed Blocks</b>
			<p>
			You can think of the OBB as a file with objects stacked like this:
			<pre class="pad code">
    &lt;null_padding&gt; pgsr &lt;resource_name&gt; &lt;compressed_data&gt; &lt;null_padding&gt;</pre>
			<ul>
			<p>&bull; <span class="code">&lt;null_padding&gt;</span> : long blocks of null characters (<span class="code">0x00</span>)</p>
			<p>&bull; <span class="code">pgsr</span> : literally the ASCII letters <span class="code">pgsr</span></p>
			<p>&bull; <span class="code">&lt;resource_name&gt;</span> : name of the resource (eg: <span class="code">UI_SEEDPACKETS_1536_00.PTX</span>)</p>
			<p>&bull; <span class="code">&lt;compressed_data&gt;</span>: blocks of zlib-compressed data. They start with the zlib headers (<span class="code">0x78 0xda</span> in the international version and <span class="code">0x78 0x9c</span> in the Chinese version)</p>
			</ul>
			<p>
			We are interested in <span class="code">&lt;compressed_data&gt;</span>. The <span class="code">offset</span> is where the compressed data block starts, ie: exactly where the <span class="code">0x78</span> is found. 
			The size of the compressed block will vary depending on what is compressed, but you can usually find where it ends by looking for the next <span class="code">pgsr</span> string, and then looking for where the null bytes start.
			</p>
			<p>If this doesn't make sense, I suggest looking at an existing OBB file and going to the offsets defined in config.cfg.</p>
        </div>
    </li>
    <li>
        <input type="radio" name="tabs" id="tab4">
        <label for="tab4">Changelog</label>
        <div id="tab-content4" class="tab-content">
            <h3>Changelog</h3>
			<div>
			<p>&bull; v0.05b: Fixed bug where versions.cfg doesn't load properly in some systems</p>
			<p>&bull; v0.05: Added configurable version definitions and 3.7.1 support</p>
			<p>&bull; v0.04b: Added iPad 3.6.2 RSB definition; added expected filesizes</p>
			<p>&bull; v0.04: Added extraction functionality and RSB (iOS) support</p>
			<p>&bull; v0.03: Added support for multiple OBB versions (3.4.4, 3.5.1, and 3.6.1)</p>
			<p>&bull; v0.02: Added GUI</p>
			<p>&bull; v0.01: Initial release</p>
			</div>
        </div>
    </li>	
	<br style="clear: both;" />
</ul>

</div>

</body>
</html>